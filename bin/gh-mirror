#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TOOL_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CONFIGURE_SCRIPT="$TOOL_ROOT/scripts/configure-gh-env.sh"
WORKFLOW_SCRIPT="$TOOL_ROOT/scripts/setup-gha.sh"

print_help() {
  cat <<'EOF'
gh-mirror - configure GitHub â†’ GitLab mirroring for the current repository.

Usage:
  gh-mirror             # run both configuration helpers (secrets + workflow)
  gh-mirror configure   # only run GitHub secrets/variables setup
  gh-mirror workflow    # only generate/update the GitHub Actions workflow
  gh-mirror help        # show this help

You must execute gh-mirror from inside the GitHub repository you want to mirror.
EOF
}

ensure_dependency_scripts() {
  if [[ ! -x "$CONFIGURE_SCRIPT" ]] || [[ ! -x "$WORKFLOW_SCRIPT" ]]; then
    cat >&2 <<'EOF'
Error: required helper scripts not found. Reinstall gh-mirror with the installer:
  curl -fsSL https://raw.githubusercontent.com/Santeau/gh-to-gl-migrator/main/install.sh | bash
EOF
    exit 1
  fi
}

ensure_git_repo() {
  if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: gh-mirror must be run inside a Git repository." >&2
    exit 1
  fi
}

run_configure() {
  echo "=== GitHub environment setup (secrets & variables) ==="
  bash "$CONFIGURE_SCRIPT"
}

run_workflow() {
  echo "=== GitHub Actions workflow setup ==="
  bash "$WORKFLOW_SCRIPT"
}

main() {
  local action="${1:-full}"

  case "$action" in
    help|-h|--help)
      print_help
      return 0
      ;;
    configure|config)
      ensure_dependency_scripts
      ensure_git_repo
      run_configure
      ;;
    workflow|gha|workflow-only)
      ensure_dependency_scripts
      ensure_git_repo
      run_workflow
      ;;
    full|setup|all|"")
      ensure_dependency_scripts
      ensure_git_repo
      run_configure
      run_workflow
      ;;
    *)
      echo "Unknown action: $action" >&2
      print_help >&2
      exit 1
      ;;
  esac
}

main "$@"

