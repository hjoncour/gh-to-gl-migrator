#!/usr/bin/env bash
set -euo pipefail

# Find the scripts directory - check multiple locations
find_scripts_dir() {
  local script_dir
  script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

  # 1. Check relative to the script (for development / running from repo)
  if [[ -d "$script_dir/../scripts" ]]; then
    echo "$(cd "$script_dir/.." && pwd)/scripts"
    return 0
  fi

  # 2. Check ~/.gh-mirror/scripts (standard install location)
  if [[ -d "$HOME/.gh-mirror/scripts" ]]; then
    echo "$HOME/.gh-mirror/scripts"
    return 0
  fi

  # 3. Check GH_MIRROR_HOME if set
  if [[ -n "${GH_MIRROR_HOME:-}" && -d "$GH_MIRROR_HOME/scripts" ]]; then
    echo "$GH_MIRROR_HOME/scripts"
    return 0
  fi

  return 1
}

SCRIPTS_DIR="$(find_scripts_dir)" || SCRIPTS_DIR=""
CONFIGURE_SCRIPT="$SCRIPTS_DIR/configure-gh-env.sh"
WORKFLOW_SCRIPT="$SCRIPTS_DIR/setup-gha.sh"
GITLAB_SETUP_SCRIPT="$SCRIPTS_DIR/setup-gitlab-project.sh"
KEYCHAIN_SCRIPT="$SCRIPTS_DIR/keychain.sh"

# Source keychain helpers if available
if [[ -f "$KEYCHAIN_SCRIPT" ]]; then
  source "$KEYCHAIN_SCRIPT"
fi

# Global options
AUTO_MODE=false
GITLAB_TOKEN="${GITLAB_TOKEN:-}"
GITLAB_NAMESPACE="${GITLAB_NAMESPACE:-}"
GITLAB_HOST="${GITLAB_HOST:-gitlab.com}"
MIRROR_ALL_BRANCHES=true

# Try to load token from keychain if not set
load_token_from_keychain() {
  if [[ -z "$GITLAB_TOKEN" ]] && type keychain_get &>/dev/null; then
    local stored_token
    if stored_token="$(keychain_get "$GITLAB_HOST" 2>/dev/null)" && [[ -n "$stored_token" ]]; then
      GITLAB_TOKEN="$stored_token"
      echo "Using GitLab token from keychain"
    fi
  fi
}

print_help() {
  cat <<'EOF'
ghmirror - configure GitHub → GitLab mirroring for the current repository.

Usage:
  ghmirror [options] [command]

Commands:
  setup, full       Run complete setup (secrets + GitLab project + workflow)
  configure         Only run GitHub secrets/variables setup
  workflow          Only generate/update the GitHub Actions workflow
  gitlab-setup      Only create/configure the GitLab project
  init              Initial full mirror (push all branches and tags now)
  help              Show this help

Options:
  --auto, -y        Non-interactive mode (auto-detect settings from GitHub repo)
  --token TOKEN     GitLab personal access token (or set GITLAB_TOKEN env var)
  --namespace NS    GitLab namespace/group (default: same as GitHub owner)
  --host HOST       GitLab host (default: gitlab.com)

Environment variables:
  GITLAB_TOKEN      GitLab personal access token
  GITLAB_NAMESPACE  Target GitLab namespace (group or username)
  GITLAB_HOST       GitLab instance hostname

Examples:
  ghmirror                           # Interactive setup
  ghmirror --auto                    # Fully automated setup
  ghmirror --auto --namespace myorg  # Auto setup to specific GitLab group
  ghmirror init                      # Push all branches/tags to GitLab now

You must execute ghmirror from inside the GitHub repository you want to mirror.
EOF
}

ensure_dependency_scripts() {
  if [[ -z "$SCRIPTS_DIR" ]]; then
    cat >&2 <<'EOF'
Error: Could not find ghmirror scripts directory.
Looked in:
  - Relative to ghmirror binary (../scripts/)
  - ~/.gh-mirror/scripts/
  - $GH_MIRROR_HOME/scripts/

Reinstall with:
  curl -fsSL https://raw.githubusercontent.com/hjoncour/gh-mirror/master/install.sh | bash
EOF
    exit 1
  fi

  local missing=()
  [[ ! -x "$CONFIGURE_SCRIPT" ]] && missing+=("configure-gh-env.sh")
  [[ ! -x "$WORKFLOW_SCRIPT" ]] && missing+=("setup-gha.sh")
  [[ ! -x "$GITLAB_SETUP_SCRIPT" ]] && missing+=("setup-gitlab-project.sh")

  if [[ ${#missing[@]} -gt 0 ]]; then
    cat >&2 <<EOF
Error: Missing helper scripts in $SCRIPTS_DIR: ${missing[*]}
Reinstall with:
  curl -fsSL https://raw.githubusercontent.com/hjoncour/gh-mirror/master/install.sh | bash
EOF
    exit 1
  fi
}

ensure_git_repo() {
  if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Error: ghmirror must be run inside a Git repository." >&2
    exit 1
  fi
}

ensure_gh_cli() {
  if ! command -v gh >/dev/null 2>&1; then
    echo "Error: GitHub CLI (gh) not found. Install it from https://cli.github.com" >&2
    exit 1
  fi
  if ! gh auth status >/dev/null 2>&1; then
    echo "Error: GitHub CLI not authenticated. Run 'gh auth login' first." >&2
    exit 1
  fi
}

# Get GitHub repo info
get_github_info() {
  # Use gh CLI's built-in query feature for reliable parsing
  GITHUB_REPO_NAME=$(gh repo view --json name -q '.name' 2>/dev/null) || {
    echo "Error: Could not get GitHub repository info. Are you in a GitHub repo?" >&2
    return 1
  }
  GITHUB_OWNER=$(gh repo view --json owner -q '.owner.login' 2>/dev/null) || GITHUB_OWNER=""
  GITHUB_DESCRIPTION=$(gh repo view --json description -q '.description // ""' 2>/dev/null) || GITHUB_DESCRIPTION=""
  GITHUB_VISIBILITY=$(gh repo view --json visibility -q '.visibility' 2>/dev/null | tr '[:upper:]' '[:lower:]') || GITHUB_VISIBILITY="private"
  GITHUB_DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef -q '.defaultBranchRef.name' 2>/dev/null) || GITHUB_DEFAULT_BRANCH="main"

  # Map GitHub visibility to GitLab
  case "$GITHUB_VISIBILITY" in
    public) GITLAB_VISIBILITY="public" ;;
    private) GITLAB_VISIBILITY="private" ;;
    internal) GITLAB_VISIBILITY="internal" ;;
    *) GITLAB_VISIBILITY="private" ;;
  esac

  export GITHUB_REPO_NAME GITHUB_OWNER GITHUB_DESCRIPTION GITHUB_VISIBILITY GITHUB_DEFAULT_BRANCH GITLAB_VISIBILITY
}

run_configure() {
  echo "=== GitHub environment setup (secrets & variables) ==="
  if [[ "$AUTO_MODE" == "true" ]]; then
    AUTO_MODE=true GITLAB_TOKEN="$GITLAB_TOKEN" \
      GITLAB_REPO="${GITLAB_HOST}/${GITLAB_NAMESPACE:-$GITHUB_OWNER}/${GITHUB_REPO_NAME}.git" \
      bash "$CONFIGURE_SCRIPT" --auto
  else
    bash "$CONFIGURE_SCRIPT"
  fi
}

run_gitlab_setup() {
  echo "=== GitLab project setup ==="

  local args=()
  [[ "$AUTO_MODE" == "true" ]] && args+=(--auto)
  [[ -n "$GITLAB_TOKEN" ]] && args+=(--token "$GITLAB_TOKEN")
  [[ -n "$GITLAB_HOST" ]] && args+=(--host "$GITLAB_HOST")

  # Use GitHub owner as default namespace if not specified
  local namespace="${GITLAB_NAMESPACE:-$GITHUB_OWNER}"
  args+=(--namespace "$namespace")
  args+=(--name "$GITHUB_REPO_NAME")
  args+=(--description "$GITHUB_DESCRIPTION")
  args+=(--visibility "$GITLAB_VISIBILITY")
  args+=(--default-branch "$GITHUB_DEFAULT_BRANCH")

  bash "$GITLAB_SETUP_SCRIPT" "${args[@]}"
}

run_workflow() {
  echo "=== GitHub Actions workflow setup ==="

  # Try to get GITLAB_REPO from GitHub variable if not already set
  local repo="${GITLAB_REPO:-}"
  if [[ -z "$repo" ]]; then
    repo=$(gh variable get GITLAB_REPO 2>/dev/null) || repo=""
  fi
  # Fall back to computed value only if still empty
  if [[ -z "$repo" ]]; then
    repo="${GITLAB_HOST}/${GITLAB_NAMESPACE:-$GITHUB_OWNER}/${GITHUB_REPO_NAME}.git"
  fi

  if [[ "$AUTO_MODE" == "true" ]]; then
    AUTO_MODE=true FEATURE_POLICY=always GITLAB_REPO="$repo" \
      bash "$WORKFLOW_SCRIPT" --auto
  else
    GITLAB_REPO="$repo" bash "$WORKFLOW_SCRIPT"
  fi
}

run_initial_mirror() {
  echo "=== Initial full mirror to GitLab ==="

  # Get GITLAB_REPO from GitHub variable if not set
  local gitlab_repo="${GITLAB_REPO:-}"
  if [[ -z "$gitlab_repo" ]]; then
    gitlab_repo=$(gh variable get GITLAB_REPO 2>/dev/null) || gitlab_repo=""
  fi
  if [[ -z "$gitlab_repo" ]]; then
    gitlab_repo="${GITLAB_HOST}/${GITLAB_NAMESPACE:-$GITHUB_OWNER}/${GITHUB_REPO_NAME}.git"
  fi

  # Try keychain first, then prompt
  if [[ -z "$GITLAB_TOKEN" ]]; then
    load_token_from_keychain
  fi
  if [[ -z "$GITLAB_TOKEN" ]]; then
    read -r -s -p "Enter GitLab token for initial push: " GITLAB_TOKEN
    echo
  fi

  echo "Adding GitLab remote..."
  git remote remove gitlab 2>/dev/null || true
  git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@${gitlab_repo}"

  echo "Fetching all branches and tags..."
  git fetch --all --prune --tags

  echo "Pushing all branches to GitLab..."
  # Push all local tracking branches
  git push --force --all gitlab

  echo "Pushing all tags to GitLab..."
  git push --force --tags gitlab

  echo "Initial mirror complete!"
  echo "GitLab repository: https://${gitlab_repo%.git}"

  # Clean up remote with token
  git remote remove gitlab
  echo "Note: GitLab remote removed (workflow will use secrets for future pushes)"
}

parse_args() {
  local positional=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --auto|-y)
        AUTO_MODE=true
        shift
        ;;
      --token)
        GITLAB_TOKEN="$2"
        shift 2
        ;;
      --namespace)
        GITLAB_NAMESPACE="$2"
        shift 2
        ;;
      --host)
        GITLAB_HOST="$2"
        shift 2
        ;;
      --help|-h)
        print_help
        exit 0
        ;;
      -*)
        echo "Unknown option: $1" >&2
        print_help >&2
        exit 1
        ;;
      *)
        positional+=("$1")
        shift
        ;;
    esac
  done

  # Restore positional parameters
  set -- "${positional[@]:-}"
  ACTION="${1:-full}"
}

main() {
  parse_args "$@"

  case "$ACTION" in
    help)
      print_help
      return 0
      ;;
    configure|config)
      ensure_dependency_scripts
      ensure_git_repo
      ensure_gh_cli
      get_github_info
      run_configure
      ;;
    workflow|gha|workflow-only)
      ensure_dependency_scripts
      ensure_git_repo
      ensure_gh_cli
      get_github_info
      run_workflow
      ;;
    gitlab-setup|gitlab)
      ensure_dependency_scripts
      ensure_git_repo
      ensure_gh_cli
      get_github_info
      run_gitlab_setup
      ;;
    init|initial|mirror-now)
      ensure_git_repo
      ensure_gh_cli
      get_github_info
      run_initial_mirror
      ;;
    full|setup|all|"")
      ensure_dependency_scripts
      ensure_git_repo
      ensure_gh_cli
      get_github_info
      load_token_from_keychain

      echo "GitHub repo: ${GITHUB_OWNER}/${GITHUB_REPO_NAME}"
      echo "Default branch: ${GITHUB_DEFAULT_BRANCH}"
      echo "Visibility: ${GITHUB_VISIBILITY} → ${GITLAB_VISIBILITY}"
      echo "Target GitLab: ${GITLAB_HOST}/${GITLAB_NAMESPACE:-$GITHUB_OWNER}/${GITHUB_REPO_NAME}"
      echo

      if [[ "$AUTO_MODE" == "true" ]]; then
        echo "Running in auto mode..."
        run_gitlab_setup
        run_configure
        run_workflow
        run_initial_mirror
      else
        run_configure
        run_workflow
        echo
        echo "Setup complete! To perform initial mirror now, run:"
        echo "  ghmirror init"
      fi
      ;;
    *)
      echo "Unknown action: $ACTION" >&2
      print_help >&2
      exit 1
      ;;
  esac
}

main "$@"
